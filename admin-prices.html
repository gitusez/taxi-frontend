<!-- admin-prices.html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    input { padding: 5px; width: 100px; }
    td, th { padding: 5px; }
    .save-btn { margin-top: 10px; padding: 10px 20px; }
  </style>
</head>
<body>
  <h1>–†—É—á–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ –∞–≤—Ç–æ</h1>
  <table border="1" id="pricesTable">
    <thead>
      <tr>
        <th>–ì–æ—Å. –Ω–æ–º–µ—Ä</th>
        <th>–ü—Ä–æ–∫–∞—Ç</th>
        <th>–ê—Ä–µ–Ω–¥–∞</th>
        <th>–í—ã–∫—É–ø</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button class="save-btn" onclick="savePrices()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

  <script>
    let prices = {};
    let allCars = [];
  
    async function loadPrices() {
      const [pricesRes, carsRes] = await Promise.all([
        fetch('/api/manual-prices'),
        fetch('/api/cars/combined', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: 1000, offset: 0 })
        })
      ]);
  
      prices = await pricesRes.json();
      const carsData = await carsRes.json();
      allCars = carsData.cars_list || [];
  
      const tbody = document.querySelector("#pricesTable tbody");
      tbody.innerHTML = "";
  
      const seen = new Set();
  
      allCars.forEach(car => {
        const number = (car.number || '').replace(/\s/g, '').toUpperCase();
        if (!number || seen.has(number)) return;
        seen.add(number);
  
        const manual = prices[number] || {};
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${number}</td>
          <td><input value="${manual.prokat || ''}" data-number="${number}" data-type="prokat"></td>
          <td><input value="${manual.rent || ''}" data-number="${number}" data-type="rent"></td>
          <td><input value="${manual.buyout || ''}" data-number="${number}" data-type="buyout"></td>
        `;
        tbody.appendChild(row);
      });
    }
  
    async function savePrices() {
      const inputs = document.querySelectorAll("input");
      const updated = {};
  
      inputs.forEach(input => {
        const number = input.dataset.number;
        const type = input.dataset.type;
        const value = input.value.trim();
        if (!updated[number]) updated[number] = {};
        if (value) updated[number][type] = isNaN(value) ? value : Number(value);
      });
  
      const res = await fetch('/api/manual-prices', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updated)
      });
  
      const result = await res.json();
      if (result.success) {
        alert("–¶–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
        loadPrices();
      } else {
        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + result.error);
      }
    }
  
    loadPrices();
  </script>
  
</body>
</html> -->


<!-- <!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    input { padding: 5px; width: 100px; }
    td, th { padding: 5px; }
    .save-btn { margin-top: 10px; padding: 10px 20px; }
  </style>
</head>
<body>
  <h1>–†—É—á–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ –∞–≤—Ç–æ</h1>
  <table border="1" id="pricesTable">
    <thead>
      <tr>
        <th>–ì–æ—Å. –Ω–æ–º–µ—Ä</th>
        <th>–ü—Ä–æ–∫–∞—Ç</th>
        <th>–ê—Ä–µ–Ω–¥–∞</th>
        <th>–í—ã–∫—É–ø</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button class="save-btn" onclick="savePrices()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

  <script>
    let prices = {}, allCars = [];

    async function loadPrices() {
      const [pr, cr] = await Promise.all([
        fetch('/api/manual-prices', { credentials: 'include' }),
        fetch('/api/cars/combined', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: 1000, offset: 0 })
        })
      ]);
      prices = await pr.json();
      const carsData = await cr.json();
      allCars = carsData.cars_list || [];

      const tbody = document.querySelector("#pricesTable tbody");
      tbody.innerHTML = "";
      const seen = new Set();

      allCars.forEach(car => {
        const num = (car.number||'').replace(/\s/g,'').toUpperCase();
        if (!num || seen.has(num)) return;
        seen.add(num);
        const m = prices[num]||{};
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${num}</td>
          <td><input value="${m.prokat||''}" data-number="${num}" data-type="prokat"></td>
          <td><input value="${m.rent||''}"  data-number="${num}" data-type="rent"></td>
          <td><input value="${m.buyout||''}" data-number="${num}" data-type="buyout"></td>
        `;
        tbody.appendChild(row);
      });
    }

    async function savePrices() {
      const updated = {};
      document.querySelectorAll("input").forEach(i => {
        const num = i.dataset.number, t = i.dataset.type, v = i.value.trim();
        if (!updated[num]) updated[num]={};
        if (v) updated[num][t] = isNaN(v)?v:Number(v);
      });
      const res = await fetch('/api/manual-prices', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updated)
      });
      const rj = await res.json();
      if (rj.success) { alert("–¶–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã"); loadPrices(); }
      else alert("–û—à–∏–±–∫–∞: "+rj.error);
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadPrices();

    // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º Basic Auth
    window.addEventListener('beforeunload', () => {
      navigator.sendBeacon('/logout');
    });
  </script>
</body>
</html> -->




<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    input { padding: 5px; width: 100px; }
    td, th { padding: 5px; }
    .save-btn { margin-top: 10px; padding: 10px 20px; }
    #spinner { display: none; }
  </style>
</head>
<body>
  <h1>–†—É—á–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ –∞–≤—Ç–æ</h1>
  <div id="spinner">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  <table border="1" id="pricesTable">
    <thead>
      <tr>
        <th>–ì–æ—Å. –Ω–æ–º–µ—Ä</th>
        <th>–ü—Ä–æ–∫–∞—Ç</th>
        <th>–ê—Ä–µ–Ω–¥–∞</th>
        <th>–í—ã–∫—É–ø</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button class="save-btn" onclick="savePrices()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

  <script>
    let prices = {}, allCars = [];

    async function loadPrices() {
      document.getElementById('spinner').style.display = 'block';
      try {
        const [pr, cr] = await Promise.all([
          fetch('/api/manual-prices', { credentials: 'include' }),
          fetch('/api/cars/combined', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: 1000, offset: 0 })
          })
        ]);

        // –µ—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã ‚Äî –ø–µ—Ä–µ–±—Ä–æ—Å–∏–º –Ω–∞ Basic Auth  
        if (pr.status === 401) {
          window.location.reload();
          return;
        }
        if (!pr.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–µ–Ω: ${pr.status}`);
        if (!cr.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∞–≤—Ç–æ: ${cr.status}`);

        prices = await pr.json();
        const carsData = await cr.json();
        allCars = carsData.cars_list || [];

        renderTable();
      } catch (err) {
        alert(err.message);
      } finally {
        document.getElementById('spinner').style.display = 'none';
      }
    }

    function renderTable() {
      const tbody = document.querySelector("#pricesTable tbody");
      tbody.innerHTML = "";
      const seen = new Set();

      allCars.forEach(car => {
        const num = (car.number||'').replace(/\s/g,'').toUpperCase();
        if (!num || seen.has(num)) return;
        seen.add(num);
        const m = prices[num] || {};
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${num}</td>
          <td><input value="${m.prokat||''}" data-number="${num}" data-type="prokat"></td>
          <td><input value="${m.rent||''}"  data-number="${num}" data-type="rent"></td>
          <td><input value="${m.buyout||''}" data-number="${num}" data-type="buyout"></td>
        `;
        tbody.appendChild(row);
      });
    }

    async function savePrices() {
      const updated = {};
      document.querySelectorAll("input").forEach(i => {
        const num = i.dataset.number, t = i.dataset.type, v = i.value.trim();
        if (!updated[num]) updated[num] = {};
        if (v) updated[num][t] = isNaN(v) ? v : Number(v);
      });

      try {
        const res = await fetch('/api/manual-prices', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updated)
        });
        if (res.status === 401) {
          window.location.reload();
          return;
        }
        if (!res.ok) throw new Error(`–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª ${res.status}`);
        const rj = await res.json();
        if (rj.success) {
          alert("–¶–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
          await loadPrices();
        } else {
          throw new Error(rj.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
      } catch (err) {
        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + err.message);
      }
    }

    // –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadPrices();

    // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ ‚Äî —Å–±—Ä–æ—Å Basic Auth
    window.addEventListener('beforeunload', () => {
      navigator.sendBeacon('/logout');
    });
  </script>
</body>
</html>
