<!-- <!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    input { padding: 5px; width: 100px; }
    td, th { padding: 5px; }
    .save-btn { margin-top: 10px; padding: 10px 20px; }
    #spinner { display: none; }

    input.photo-upload {
  padding: 6px;
  border: 1px solid #ccc;
  background: #f9f9f9;
  cursor: pointer;
  width: 100%;
}

.upload-info {
  font-size: 12px;
  color: #555;
  margin-top: 4px;
}

  </style>
</head>
<body>
  <h1>–†—É—á–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ –∞–≤—Ç–æ</h1>
  <div id="spinner">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  <table border="1" id="pricesTable">
    <thead>
      <tr>
        <th>–ì–æ—Å. –Ω–æ–º–µ—Ä</th>
        <th>–ü—Ä–æ–∫–∞—Ç</th>
        <th>–ê—Ä–µ–Ω–¥–∞</th>
        <th>–í—ã–∫—É–ø</th>
        <th>–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è</th>
        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button class="save-btn" onclick="savePrices()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

  <script>
    let prices = {}, allCars = [];

    async function loadPrices() {
      document.getElementById('spinner').style.display = 'block';
      try {
        const [pr, cr] = await Promise.all([
          fetch('/api/manual-prices', { credentials: 'include' }),
          fetch('/api/cars/combined', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: 1000, offset: 0 })
          })
        ]);

        // –µ—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã ‚Äî –ø–µ—Ä–µ–±—Ä–æ—Å–∏–º –Ω–∞ Basic Auth  
        if (pr.status === 401) {
          window.location.reload();
          return;
        }
        if (!pr.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–µ–Ω: ${pr.status}`);
        if (!cr.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∞–≤—Ç–æ: ${cr.status}`);

        prices = await pr.json();
        const carsData = await cr.json();
        allCars = carsData.cars_list || [];

        renderTable();
      } catch (err) {
        alert(err.message);
      } finally {
        document.getElementById('spinner').style.display = 'none';
      }
    }

    function renderTable() {
      const tbody = document.querySelector("#pricesTable tbody");
      tbody.innerHTML = "";
      const seen = new Set();

      allCars.forEach(car => {
        const num = (car.number||'').replace(/\s/g,'').toUpperCase();
        if (!num || seen.has(num)) return;
        seen.add(num);
        const m = prices[num] || {};
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${num}</td>
          <td><input value="${m.prokat||''}" data-number="${num}" data-type="prokat"></td>
          <td><input value="${m.rent||''}"  data-number="${num}" data-type="rent"></td>
          <td><input value="${m.buyout||''}" data-number="${num}" data-type="buyout"></td>
          <td><textarea   data-number="${num}" data-type="equipment" placeholder="–∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è">${m.equipment||''}</textarea></td>
          <td><textarea   data-number="${num}" data-type="description" placeholder="–æ–ø–∏—Å–∞–Ω–∏–µ">${m.description||''}</textarea></td>
          <td>
          <div>
          <input type="file" accept=".jpeg,.jpg,.png" multiple data-number="${num}" class="photo-upload">
          <div class="upload-info" id="info-${num}">–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>
          <button class="upload-btn" data-number="${num}">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          </div>
          </td>

        `;
        tbody.appendChild(row);
      });
    }

  async function savePrices() {
  const updated = {};

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –ø–æ–ª—è <input> (—Ü–µ–Ω—ã)
  document.querySelectorAll("input[data-number][data-type]").forEach(i => {
    const num   = i.dataset.number;
    const type  = i.dataset.type;
    const value = i.value.trim();
    if (!updated[num]) updated[num] = {};
    if (value) {
      updated[num][type] = isNaN(value) ? value : Number(value);
    }
  });

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ <textarea> (–∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è –∏ –æ–ø–∏—Å–∞–Ω–∏–µ)
  document.querySelectorAll("textarea[data-number][data-type]").forEach(t => {
    const num   = t.dataset.number;
    const type  = t.dataset.type;
    const value = t.value.trim();
    if (!updated[num]) updated[num] = {};
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–∂–µ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—á–∏—â–∞—Ç—å –ø–æ–ª—è
    updated[num][type] = value;
  });

  try {
    const res = await fetch('/api/manual-prices', {
      method:      'POST',
      credentials: 'include',
      headers:     { 'Content-Type': 'application/json' },
      body:        JSON.stringify(updated)
    });

    if (res.status === 401) {
      window.location.reload();
      return;
    }
    if (!res.ok) {
      throw new Error(`–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª ${res.status}`);
    }

    const rj = await res.json();
    if (rj.success) {
      alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
      await loadPrices();
    } else {
      throw new Error(rj.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
    }
  } catch (err) {
    alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + err.message);
  }
}

document.addEventListener('click', async (e) => {
  if (e.target.classList.contains('upload-btn')) {
    const number = e.target.dataset.number;
    const input = document.querySelector(`input.photo-upload[data-number="${number}"]`);
    const files = input.files;

    if (!files.length) {
      alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª");
      return;
    }

    const formData = new FormData();
    formData.append('number', number);
    for (const file of files) {
      formData.append('photos', file);
    }

    try {
      const res = await fetch('/api/photos/upload', {
        method: 'POST',
        body: formData
      });
      const result = await res.json();
      if (result.success) {
        alert("–§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
        input.value = ""; // —Å–±—Ä–æ—Å–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
      } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ");
      }
    } catch (err) {
      alert("–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
    }
  }
});


document.addEventListener('change', (e) => {
  if (e.target.classList.contains('photo-upload')) {
    const number = e.target.dataset.number;
    const files = e.target.files;
    const info = document.getElementById(`info-${number}`);
    if (!files.length) {
      info.textContent = "–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
    } else {
      const names = Array.from(files).map(f => f.name).join(', ');
      info.textContent = `${files.length} —Ñ–∞–π–ª(–æ–≤): ${names}`;
    }
  }
});




    // –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadPrices();

    // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ ‚Äî —Å–±—Ä–æ—Å Basic Auth
    window.addEventListener('beforeunload', () => {
      navigator.sendBeacon('/logout');
    });
  </script>
</body>
</html> -->

<!-- <!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–µ–Ω–∞–º–∏ –∏ —Ñ–æ—Ç–æ</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    body {
      background: #f4f4f9;
      font-family: 'Segoe UI', sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #f0f0f0;
      color: #333;
    }
    tr:hover {
      background: #f9f9f9;
    }
    input[type="text"],
    textarea {
      width: 100%;
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
    }
    .upload-preview {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .upload-preview img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .btn {
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
      background: #4CAF50;
      color: white;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .btn:hover {
      background: #45a049;
    }
    .btn-secondary {
      background: #2196F3;
    }
    .btn-secondary:hover {
      background: #1976D2;
    }
  </style>
</head>
<body>

<h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–µ–Ω–∞–º–∏ –∏ —Ñ–æ—Ç–æ</h1>

<table id="price-table">
  <thead>
    <tr>
      <th>–ì–æ—Å–Ω–æ–º–µ—Ä</th>
      <th>–ü—Ä–æ–∫–∞—Ç</th>
      <th>–ê—Ä–µ–Ω–¥–∞</th>
      <th>–í—ã–∫—É–ø</th>
      <th>–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è</th>
      <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
      <th>–§–æ—Ç–æ</th>
      <th></th>
    </tr>
  </thead>
  <tbody id="price-body">
  </tbody>
</table>

<br>
<center>
  <button class="btn" onclick="savePrices()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
</center>

<script>
// async function loadPrices() {
//   const res = await fetch('/api/manual-prices');
//   const data = await res.json();
//   const tbody = document.getElementById("price-body");
//   tbody.innerHTML = '';

//   Object.entries(data).forEach(([number, fields]) => {
//     const row = document.createElement("tr");

//     row.innerHTML = `
//       <td>${number}</td>
//       <td><input data-number="${number}" data-type="rent" value="${fields.rent || ''}"></td>
//       <td><input data-number="${number}" data-type="buyout" value="${fields.buyout || ''}"></td>
//       <td><input data-number="${number}" data-type="prokat" value="${fields.prokat || ''}"></td>
//       <td><textarea data-number="${number}" data-type="equipment">${fields.equipment || ''}</textarea></td>
//       <td><textarea data-number="${number}" data-type="description">${fields.description || ''}</textarea></td>
//       <td>
//         <input type="file" accept="image/*" multiple onchange="previewPhotos(event, '${number}')">
//         <div class="upload-preview" id="preview-${number}"></div>
//       </td>
//       <td>
//         <button class="btn-secondary" onclick="uploadPhotos('${number}', this)">üì§</button>
//       </td>
//     `;
//     tbody.appendChild(row);
//   });
// }

async function loadPrices() {
  const res = await fetch('/api/manual-prices');
  const data = await res.json();
  const tbody = document.getElementById("price-body");
  tbody.innerHTML = '';

  Object.entries(data).forEach(async ([number, fields]) => {
    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${number}</td>
      <td><input data-number="${number}" data-type="prokat" value="${fields.prokat || ''}"></td>
      <td><input data-number="${number}" data-type="rent" value="${fields.rent || ''}"></td>
      <td><input data-number="${number}" data-type="buyout" value="${fields.buyout || ''}"></td>
      <td><textarea data-number="${number}" data-type="equipment">${fields.equipment || ''}</textarea></td>
      <td><textarea data-number="${number}" data-type="description">${fields.description || ''}</textarea></td>
      <td>
        <input type="file" accept="image/*" multiple onchange="previewPhotos(event, '${number}')">
        <div class="upload-preview" id="preview-${number}"></div>
      </td>
      <td>
        <button class="btn-secondary" onclick="uploadPhotos('${number}', this)">üì§</button>
      </td>
    `;
    tbody.appendChild(row);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–æ—Ç–æ
    try {
      const res = await fetch(`/api/photos/${number}`);
      const files = await res.json();
      const preview = document.getElementById(`preview-${number}`);
      files.forEach(file => {
        const img = document.createElement('img');
        img.src = `/photos/${number}/${file}`;
        preview.appendChild(img);
      });
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –¥–ª—è', number, err);
    }
  });
}


async function savePrices() {
  const updated = {};
  document.querySelectorAll("input, textarea").forEach(i => {
    const num = i.dataset.number, t = i.dataset.type, v = i.value.trim();
    if (!num || !t) return;
    if (!updated[num]) updated[num] = {};
    if (v) updated[num][t] = v;
  });

  try {
    const res = await fetch('/api/manual-prices', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updated)
    });
    const rj = await res.json();
    if (rj.success) {
      alert("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
      await loadPrices();
    } else {
      throw new Error(rj.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
    }
  } catch (err) {
    alert("‚ùå –û—à–∏–±–∫–∞: " + err.message);
  }
}

function previewPhotos(event, number) {
  const files = event.target.files;
  const preview = document.getElementById(`preview-${number}`);
  preview.innerHTML = '';
  Array.from(files).forEach(file => {
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    preview.appendChild(img);
  });
}

async function uploadPhotos(number, btn) {
  const input = btn.closest('tr').querySelector('input[type="file"]');
  if (!input || !input.files.length) {
    alert("‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ");
    return;
  }

  const formData = new FormData();
  formData.append("number", number);
  Array.from(input.files).forEach(file => formData.append("photos", file));

  try {
    btn.disabled = true;
    btn.textContent = "‚è≥";
    const res = await fetch('/api/photos/upload', {
      method: "POST",
      body: formData
    });
    const rj = await res.json();
    if (rj.success) {
      alert("‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ " + input.files.length + " —Ñ–æ—Ç–æ");
    } else {
      throw new Error(rj.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ');
    }
  } catch (err) {
    alert("‚ùå " + err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = "üì§";
  }
}

loadPrices();
</script>

</body>
</html> -->



<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–µ–Ω–∞–º–∏ –∏ —Ñ–æ—Ç–æ</title>
  <style>
    /* (—Ç–æ—Ç –∂–µ CSS, —á—Ç–æ —É –≤–∞—Å —Å–µ–π—á–∞—Å) */
  </style>
</head>
<body>

<h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–µ–Ω–∞–º–∏ –∏ —Ñ–æ—Ç–æ</h1>

<table id="price-table">
  <thead>
    <tr>
      <th>–ì–æ—Å–Ω–æ–º–µ—Ä</th>
      <th>–ü—Ä–æ–∫–∞—Ç</th>
      <th>–ê—Ä–µ–Ω–¥–∞</th>
      <th>–í—ã–∫—É–ø</th>
      <th>–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è</th>
      <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
      <th>–§–æ—Ç–æ</th>
      <th></th>
    </tr>
  </thead>
  <tbody id="price-body"></tbody>
</table>

<br>
<center>
  <button class="btn" onclick="savePrices()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
</center>

<script>
  let manualPrices = {};   // —Å—é–¥–∞ –∑–∞–≥—Ä—É–∑–∏–º JSON –∏–∑ /api/manual-prices
  let allCars       = [];  // —Å—é–¥–∞ –∑–∞–≥—Ä—É–∑–∏–º cars_list –∏–∑ /api/cars/combined

  async function loadPrices() {
    // –ü–æ–∫–∞–∂–µ–º —Å–ø–∏–Ω–Ω–µ—Ä/–∑–∞–≤–µ—Ä–Ω–µ–º –≤—Å—ë –≤ try‚Ä¶catch, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ‚Äú—Å–ª–æ–º–∞–Ω–Ω–æ–π‚Äù —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    try {
      // 1) –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—Ä–æ—Å–∏–º ¬´—Ä—É—á–Ω—ã–µ —Ü–µ–Ω—ã¬ª (Basic Auth, –µ—Å–ª–∏ –Ω–∞–¥–æ, credentials: 'include')
      const prRes = await fetch('/api/manual-prices', { credentials: 'include' });
      if (prRes.status === 401) {
        // –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞, –±—Ä–∞—É–∑–µ—Ä —Å–∞–º –ø–æ–∫–∞–∂–µ—Ç popup Basic Auth
        return;
      }
      if (!prRes.ok) {
        throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä—É—á–Ω—ã—Ö —Ü–µ–Ω: ${prRes.status}`);
      }
      manualPrices = await prRes.json();

      // 2) –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–∏–ª–∏ –ø–æ—Å–ª–µ) –∑–∞–ø—Ä–æ—Å–∏–º —Å–ø–∏—Å–æ–∫ –º–∞—à–∏–Ω –∏–∑ CRM
      //    (—Å–µ—Ä–≤–µ—Ä –∂–¥—ë—Ç ¬´application/json¬ª, –ø–æ—ç—Ç–æ–º—É –Ω–µ –∑–∞–±—É–¥–µ–º Content-Type –∏ JSON-body)
      const crRes = await fetch('/api/cars/combined', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: 1000, offset: 0 })
      });
      if (!crRes.ok) {
        throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –∞–≤—Ç–æ: ${crRes.status}`);
      }
      const crJson = await crRes.json();
      // –ø–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É —Å–µ—Ä–≤–µ—Ä –¥–∞—ë—Ç { success: true, cars_list: [...], total: N }
      allCars = Array.isArray(crJson.cars_list) ? crJson.cars_list : [];

      renderTable();
    } catch (err) {
      alert(err.message);
    }
  }

  function renderTable() {
    const tbody = document.getElementById("price-body");
    tbody.innerHTML = ""; // –æ—á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ —Å—Ç—Ä–æ–∫–∏

    // –ß—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –≥–æ—Å–Ω–æ–º–µ—Ä
    const seen = new Set();

    allCars.forEach(car => {
      // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–æ–º–µ—Ä (—É–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã, –ø—Ä–∏–≤–æ–¥–∏–º –∫ uppercase)
      const num = (car.number || "").replace(/\s/g, "").toUpperCase();
      if (!num || seen.has(num)) return;
      seen.add(num);

      // ¬´—Ä—É—á–Ω—ã–µ¬ª —Ü–µ–Ω—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
      const m = manualPrices[num] || {};
      const row = document.createElement("tr");

      row.innerHTML = `
        <td>${num}</td>
        <td><input data-number="${num}" data-type="prokat" value="${m.prokat || ''}"></td>
        <td><input data-number="${num}" data-type="rent"   value="${m.rent   || ''}"></td>
        <td><input data-number="${num}" data-type="buyout" value="${m.buyout || ''}"></td>
        <td><textarea data-number="${num}" data-type="equipment" placeholder="–∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è">${m.equipment || car.equipment || ''}</textarea></td>
        <td><textarea data-number="${num}" data-type="description" placeholder="–æ–ø–∏—Å–∞–Ω–∏–µ">${m.description || ''}</textarea></td>
        <td>
          <input type="file" accept="image/*" multiple onchange="previewPhotos(event, '${num}')">
          <div class="upload-preview" id="preview-${num}"></div>
        </td>
        <td>
          <button class="btn-secondary" onclick="uploadPhotos('${num}', this)">üì§</button>
        </td>
      `;
      tbody.appendChild(row);

      // –ü–æ–¥–≥—Ä—É–∑–∏–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–æ—Ç–æ (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏ –ø–æ–∫–∞–∂–µ–º –ø—Ä–µ–≤—å—é
      fetch(`/api/photos/${num}`)
        .then(r => r.ok ? r.json() : [])
        .then(files => {
          const preview = document.getElementById(`preview-${num}`);
          if (!Array.isArray(files)) return;
          files.forEach(fileUrl => {
            const img = document.createElement('img');
            // –∑–¥–µ—Å—å —Å–µ—Ä–≤–µ—Ä –æ—Ç–¥–∞—ë—Ç –ª–∏–±–æ –∏–º–µ–Ω–∞, –ª–∏–±–æ —É–∂–µ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å,
            // –≤ –≤–∞—à–µ–º –∫–æ–¥–µ –ø–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è URL-–æ–≤ –≤—ã, –∫–∞–∂–µ—Ç—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç–µ { success, photos:[ "/photos/XXX/–∏–º—è.jpg", ‚Ä¶ ] }
            img.src = fileUrl;
            preview.appendChild(img);
          });
        })
        .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –¥–ª—è', num, err));
    });

    // –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ—Ç –º–∞—à–∏–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—â—ë –≤ CRM –Ω–∏—á–µ–≥–æ –Ω–µ—Ç),
    // –º–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ ¬´–Ω–µ—Ç –º–∞—à–∏–Ω¬ª –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π.
    if (allCars.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8">–ù–µ—Ç –º–∞—à–∏–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
    }
  }

  async function savePrices() {
    const updated = {};
    document.querySelectorAll("input[data-number][data-type], textarea[data-number][data-type]").forEach(elem => {
      const num  = elem.dataset.number;
      const type = elem.dataset.type;
      const val  = elem.value.trim();
      if (!updated[num]) updated[num] = {};
      if (val !== "") {
        // –µ—Å–ª–∏ –ø–æ–ª–µ –æ–ø–∏—Å–∞–Ω–∏—è –∏–ª–∏ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç, –∏–Ω–∞—á–µ –ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —á–∏—Å–ª—É
        updated[num][type] = (type === 'equipment' || type === 'description') ? val : (isNaN(val) ? val : Number(val));
      }
    });

    try {
      const res = await fetch('/api/manual-prices', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updated)
      });
      if (!res.ok) throw new Error(`–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª ${res.status}`);
      const rj = await res.json();
      if (rj.success) {
        alert("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
        await loadPrices(); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
      } else {
        throw new Error(rj.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
      }
    } catch (err) {
      alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: " + err.message);
    }
  }

  function previewPhotos(event, number) {
    const files = Array.from(event.target.files);
    const preview = document.getElementById(`preview-${number}`);
    preview.innerHTML = '';
    files.forEach(file => {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      preview.appendChild(img);
    });
  }

  async function uploadPhotos(number, btn) {
    const input = btn.closest('tr').querySelector('input[type="file"]');
    if (!input.files.length) {
      alert("‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã");
      return;
    }
    const formData = new FormData();
    formData.append("number", number);
    Array.from(input.files).forEach(f => formData.append("photos", f));
    try {
      btn.disabled = true;
      btn.textContent = "‚è≥";
      const res = await fetch('/api/photos/upload', { method: 'POST', body: formData });
      const rj = await res.json();
      if (rj.success) {
        alert(`‚úÖ ${input.files.length} —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ`);
      } else {
        throw new Error(rj.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ');
      }
    } catch (err) {
      alert("‚ùå " + err.message);
    } finally {
      btn.disabled = false;
      btn.textContent = "üì§";
    }
  }

  // –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å—Ä–∞–∑—É –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –æ–±–∞ —Å–ø–∏—Å–∫–∞
  loadPrices();
</script>

</body>
</html>
