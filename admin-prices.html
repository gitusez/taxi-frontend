<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–µ–Ω–∞–º–∏ –∏ —Ñ–æ—Ç–æ</title>
  <style>
    body {
      background: #f4f4f9;
      font-family: 'Segoe UI', sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #f0f0f0;
      color: #333;
    }
    tr:hover {
      background: #f9f9f9;
    }
    input[type="text"],
    textarea {
      width: 100%;
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
    }
    .upload-preview {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .upload-preview img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .btn {
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
      background: #4CAF50;
      color: white;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .btn:hover {
      background: #45a049;
    }
    .btn-secondary {
      background: #2196F3;
    }
    .btn-secondary:hover {
      background: #1976D2;
    }
  </style>
</head>
<body>

<h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–µ–Ω–∞–º–∏ –∏ —Ñ–æ—Ç–æ</h1>

<table id="price-table">
  <thead>
    <tr>
      <th>–ì–æ—Å–Ω–æ–º–µ—Ä</th>
      <th>–õ–æ—Ç</th>
      <th>–ü—Ä–æ–∫–∞—Ç</th>
      <th>–ê—Ä–µ–Ω–¥–∞</th>
      <th>–í—ã–∫—É–ø</th>
      <th>–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è</th>
      <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
      <th>–°–æ —Å–∫–∏–¥–∫–æ–π</th>
      <th>–§–æ—Ç–æ</th>
    </tr>
  </thead>
  <tbody id="price-body"></tbody>
</table>

<br>
<center>
  <button class="btn" onclick="savePrices()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
</center>

<script>
  let manualPrices = {};
  let allCars = [];

  async function loadPrices() {
    try {
      const prRes = await fetch('/api/manual-prices', { credentials: 'include' });
      if (prRes.status === 401) return;
      if (!prRes.ok) throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä—É—á–Ω—ã—Ö —Ü–µ–Ω: ${prRes.status}`);
      manualPrices = await prRes.json();

      const crRes = await fetch('/api/cars/combined', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: 1000, offset: 0 })
      });
      if (!crRes.ok) throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –∞–≤—Ç–æ: ${crRes.status}`);
      const crJson = await crRes.json();
      allCars = Array.isArray(crJson.cars_list) ? crJson.cars_list : [];

      renderTable();
    } catch (err) {
      alert(err.message);
    }
  }

  // function renderTable() {
  //   const tbody = document.getElementById("price-body");
  //   tbody.innerHTML = "";
  //   const seen = new Set();

  //   allCars.forEach(car => {
  //     const num = (car.number || "").replace(/\s/g, "").toUpperCase();
  //     if (!num || seen.has(num)) return;
  //     seen.add(num);

  //     const m = manualPrices[num] || {};
  //     const row = document.createElement("tr");

  //     row.innerHTML = `
  //       <td>${num}</td>
  //       <td><input data-number="${num}" data-type="prokat" value="${m.prokat || ''}"></td>
  //       <td><input data-number="${num}" data-type="rent" value="${m.rent || ''}"></td>
  //       <td><input data-number="${num}" data-type="buyout" value="${m.buyout || ''}"></td>
  //       <td><textarea data-number="${num}" data-type="equipment">${m.equipment || car.equipment || ''}</textarea></td>
  //       <td><textarea data-number="${num}" data-type="description">${m.description || ''}</textarea></td>
  //       <td style="text-align:center;">
  //         <input type="checkbox" data-number="${num}" data-type="discount" ${m.discount ? 'checked' : ''}>
  //       </td>
  //       <td>
  //         <input type="file" accept="image/*" multiple onchange="previewPhotos(event, '${num}')">
  //         <div class="upload-preview" id="preview-${num}"></div>
  //         <button class="btn-secondary" onclick="uploadPhotos('${num}', this)">üì§</button>
  //       </td>
  //     `;
  //     tbody.appendChild(row);

  //     fetch(`/api/photos/${num}`)
  //       .then(r => r.ok ? r.json() : [])
  //       .then(files => {
  //         const preview = document.getElementById(`preview-${num}`);
  //         if (!Array.isArray(files)) return;
  //         files.forEach(fileUrl => {
  //           const img = document.createElement('img');
  //           img.src = fileUrl;
  //           preview.appendChild(img);
  //         });
  //       });
  //   });

  //   if (allCars.length === 0) {
  //     tbody.innerHTML = '<tr><td colspan="8">–ù–µ—Ç –º–∞—à–∏–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
  //   }
  // }

// function renderTable() {
//   const tbody = document.getElementById("price-body");
//   tbody.innerHTML = "";
//   const seen = new Set();

//   allCars.forEach(car => {
//     const num = (car.number || "").replace(/\s/g, "").toUpperCase();
//     if (!num || seen.has(num)) return;
//     seen.add(num);

//     const m = manualPrices[num] || {};
//     const row = document.createElement("tr");

//     row.innerHTML = `
//       <td>${num}</td>
//       <td><input data-number="${num}" data-type="lot" value="${m.lot || car.lot || ''}"></td>
//       <td><input data-number="${num}" data-type="prokat" value="${m.prokat || ''}"></td>
//       <td><input data-number="${num}" data-type="rent" value="${m.rent || ''}"></td>
//       <td><input data-number="${num}" data-type="buyout" value="${m.buyout || ''}"></td>
//       <td><textarea data-number="${num}" data-type="equipment">${m.equipment || car.equipment || ''}</textarea></td>
//       <td><textarea data-number="${num}" data-type="description">${m.description || ''}</textarea></td>
//       <td style="text-align:center;">
//         <input type="checkbox" data-number="${num}" data-type="discount" ${m.discount ? 'checked' : ''}>
//       </td>
//       <td>
//         <input type="file" accept="image/*" multiple onchange="previewPhotos(event, '${num}')">
//         <div class="upload-preview" id="preview-${num}"></div>
//         <button class="btn-secondary" onclick="uploadPhotos('${num}', this)">üì§</button>
//       </td>
//     `;
//     tbody.appendChild(row);

//     // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ, –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ
//     fetch(`/api/photos/${num}`)
//       .then(r => r.ok ? r.json() : [])
//       .then(files => {
//         const preview = document.getElementById(`preview-${num}`);
//         if (!Array.isArray(files)) return;
//         files.forEach(fileUrl => {
//           const img = document.createElement('img');
//           img.src = fileUrl;
//           preview.appendChild(img);
//         });
//       });
//   });

//   if (allCars.length === 0) {
//     tbody.innerHTML = '<tr><td colspan="9">–ù–µ—Ç –º–∞—à–∏–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
//   }
// }



//   async function savePrices() {
//     const updated = {};
//     document.querySelectorAll("input[data-number][data-type], textarea[data-number][data-type]").forEach(elem => {
//       const num = elem.dataset.number;
//       const type = elem.dataset.type;
//       const val = elem.type === 'checkbox' ? elem.checked : elem.value.trim();
//       if (!updated[num]) updated[num] = {};
//       if (val !== "") updated[num][type] = val;
//     });

//     try {
//       const res = await fetch('/api/manual-prices', {
//         method: 'POST',
//         credentials: 'include',
//         headers: { 'Content-Type': 'application/json' },
//         body: JSON.stringify(updated)
//       });
//       if (!res.ok) throw new Error(`–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª ${res.status}`);
//       const rj = await res.json();
//       if (rj.success) {
//         alert("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
//         await loadPrices();
//       } else {
//         throw new Error(rj.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
//       }
//     } catch (err) {
//       alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: " + err.message);
//     }
//   }

function renderTable() {
  const tbody = document.getElementById("price-body");
  tbody.innerHTML = "";
  const seen = new Set();

  allCars.forEach(car => {
    const num = (car.number || "").replace(/\s/g, "").toUpperCase();
    if (!num || seen.has(num)) return;
    seen.add(num);

    const m = manualPrices[num] || {};
    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${num}</td>
      <td><input data-number="${num}" data-type="lot" value="${m.lot || car.lot || ''}"></td>
      <td><input data-number="${num}" data-type="prokat" value="${m.prokat || ''}"></td>
      <td><input data-number="${num}" data-type="rent" value="${m.rent || ''}"></td>
      <td><input data-number="${num}" data-type="buyout" value="${m.buyout || ''}"></td>
      <td><textarea data-number="${num}" data-type="equipment">${m.equipment || car.equipment || ''}</textarea></td>
      <td><textarea data-number="${num}" data-type="description">${m.description || ''}</textarea></td>
      <td style="text-align:center;">
        <input type="checkbox" data-number="${num}" data-type="discount" ${m.discount ? 'checked' : ''}>
      </td>
      <td>
        <input type="file" accept="image/*" multiple onchange="previewPhotos(event, '${num}')">
        <div class="upload-preview" id="preview-${num}"></div>
        <button class="btn-secondary" onclick="uploadPhotos('${num}', this)">üì§</button>
      </td>
    `;
    tbody.appendChild(row);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ
    fetch(`/api/photos/${num}`)
      .then(r => r.ok ? r.json() : [])
      .then(files => {
        const preview = document.getElementById(`preview-${num}`);
        if (!Array.isArray(files)) return;
        files.forEach(fileUrl => {
          const img = document.createElement('img');
          img.src = fileUrl;
          preview.appendChild(img);
        });
      });
  });

  if (allCars.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9">–ù–µ—Ç –º–∞—à–∏–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
  }
}

async function savePrices() {
  const updated = {};
  document.querySelectorAll("input[data-number][data-type], textarea[data-number][data-type]").forEach(elem => {
    const num = elem.dataset.number;
    const type = elem.dataset.type;
    const val = elem.type === 'checkbox' ? elem.checked : elem.value.trim();
    if (!updated[num]) updated[num] = {};
    updated[num][type] = val; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–∂–µ –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  });

  try {
    const res = await fetch('/api/manual-prices', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updated)
    });
    if (!res.ok) throw new Error(`–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª ${res.status}`);
    const rj = await res.json();
    if (rj.success) {
      alert("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
      await loadPrices();
    } else {
      throw new Error(rj.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
    }
  } catch (err) {
    alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: " + err.message);
  }
}


  function previewPhotos(event, number) {
    const files = Array.from(event.target.files);
    const preview = document.getElementById(`preview-${number}`);
    preview.innerHTML = '';
    files.forEach(file => {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      preview.appendChild(img);
    });
  }

  async function uploadPhotos(number, btn) {
    const input = btn.closest('tr').querySelector('input[type="file"]');
    if (!input.files.length) {
      alert("‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã");
      return;
    }
    const formData = new FormData();
    formData.append("number", number);
    Array.from(input.files).forEach(f => formData.append("photos", f));
    try {
      btn.disabled = true;
      btn.textContent = "‚è≥";
      const res = await fetch('/api/photos/upload', { method: 'POST', body: formData });
      const rj = await res.json();
      if (rj.success) {
        alert(`‚úÖ ${input.files.length} —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ`);
      } else {
        throw new Error(rj.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ');
      }
    } catch (err) {
      alert("‚ùå " + err.message);
    } finally {
      btn.disabled = false;
      btn.textContent = "üì§";
    }
  }

  loadPrices();
</script>

</body>
</html>
