<!-- admin-prices.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    input { padding: 5px; width: 100px; }
    td, th { padding: 5px; }
    .save-btn { margin-top: 10px; padding: 10px 20px; }
  </style>
</head>
<body>
  <h1>–†—É—á–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ –∞–≤—Ç–æ</h1>
  <table border="1" id="pricesTable">
    <thead>
      <tr>
        <th>–ì–æ—Å. –Ω–æ–º–µ—Ä</th>
        <th>–ê—Ä–µ–Ω–¥–∞</th>
        <th>–í—ã–∫—É–ø</th>
        <th>–ü—Ä–æ–∫–∞—Ç</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button class="save-btn" onclick="savePrices()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

  <script>
    let prices = {};

    async function loadPrices() {
      const res = await fetch('/api/manual-prices');
      prices = await res.json();
      const tbody = document.querySelector("#pricesTable tbody");
      tbody.innerHTML = "";

      Object.keys(prices).forEach(number => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${number}</td>
          <td><input value="${prices[number].rent || ''}" data-number="${number}" data-type="rent"></td>
          <td><input value="${prices[number].buyout || ''}" data-number="${number}" data-type="buyout"></td>
          <td><input value="${prices[number].prokat || ''}" data-number="${number}" data-type="prokat"></td>
        `;
        tbody.appendChild(row);
      });
    }

    async function savePrices() {
      const inputs = document.querySelectorAll("input");
      const updated = {};

      inputs.forEach(input => {
        const number = input.dataset.number;
        const type = input.dataset.type;
        const value = input.value.trim();

        if (!updated[number]) updated[number] = {};
        if (value) updated[number][type] = isNaN(value) ? value : Number(value);
      });

      const res = await fetch('/api/manual-prices', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updated)
      });

      const result = await res.json();
      if (result.success) {
        alert("–¶–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
        loadPrices();
      } else {
        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + result.error);
      }
    }

    loadPrices();
  </script>
</body>
</html>
